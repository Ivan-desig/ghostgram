name: Build Ghostgram IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Bazel
        run: |
          curl -LO https://github.com/bazelbuild/bazel/releases/download/6.5.0/bazel-6.5.0-darwin-arm64
          chmod +x bazel-6.5.0-darwin-arm64
          mv bazel-6.5.0-darwin-arm64 bazel
          ./bazel version

      - name: Fix Make.py Indentation
        run: |
          sed -i '' -e '/profile_source.load_data/ i\ 
          if profile_source != "embedded":' -e 's/profile_source.load_data/if profile_source != "embedded":\n    profile_source.load_data/g' build-system/Make/Make.py

      - name: Insert API keys
        run: |
          sed -i '' "s/\#define API_ID.*/\#define API_ID ${{ secrets.API_ID }}/" Telegram/Telegram-Bridging-Header.h
          sed -i '' "s/\#define API_HASH.*/\#define API_HASH \"${{ secrets.API_HASH }}\"/" Telegram/Telegram-Bridging-Header.h

      - name: Generate Xcode project
        run: python3 build-system/Make/Make.py generateProject --configurationPath=build-system/config.json || true

      - name: Setup signing
        run: |
          mkdir -p signing
          echo "${{ secrets.APPLE_CERT_P12_BASE64 }}" | base64 -d > signing/certificate.p12
          echo "${{ secrets.APPLE_PROVISION_BASE64 }}" | base64 -d > signing/provision.mobileprovision
          security create-keychain -p password signing.keychain
          security unlock-keychain -p password signing.keychain
          security import signing/certificate.p12 -k signing.keychain -P "${{ secrets.APPLE_CERT_PASSWORD }}" -T /usr/bin/codesign

      - name: Build with Bazel
        run: |
          ./bazel clean --expunge || true
          ./bazel fetch //... || true
          ./bazel build //Telegram:Telegram --compilation_mode=opt --apple_platform_type=ios --verbose_failures --sandbox_debug

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Ghostgram-IPA
          path: bazel-bin/Telegram/Telegram.ipa
